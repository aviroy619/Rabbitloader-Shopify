<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitLoader - Shopify Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
    <script>
        // Initialize Shopify App Bridge for embedded app
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const host = urlParams.get('host');
            const shop = urlParams.get('shop');
            
            console.log('Host parameter:', host);
            console.log('Shop parameter:', shop);
            
            if (host && window.top !== window.self) {
                // We're in an iframe (embedded)
                try {
                    const AppBridge = window['app-bridge'];
                    
                    const app = AppBridge.createApp({
                        apiKey: '09d41e81fb0d15dd76bc6586d4f9ddd2',
                        host: host,
                        forceRedirect: true
                    });
                    
                    console.log('‚úÖ Shopify App Bridge initialized - running in embedded mode');
                    
                    // Set up actions for proper embedded behavior
                    const TitleBar = AppBridge.actions.TitleBar;
                    const titleBar = TitleBar.create(app, {
                        title: 'RabbitLoader Dashboard'
                    });
                    
                } catch (error) {
                    console.error('‚ùå App Bridge initialization failed:', error);
                }
            } else if (host) {
                // We have host but not in iframe, force redirect
                try {
                    const AppBridge = window['app-bridge'];
                    
                    const app = AppBridge.createApp({
                        apiKey: '09d41e81fb0d15dd76bc6586d4f9ddd2',
                        host: host,
                        forceRedirect: true
                    });
                    
                    console.log('üîÑ Forcing redirect to embedded mode');
                    
                } catch (error) {
                    console.error('‚ùå App Bridge redirect failed:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Not running in embedded mode - missing host parameter');
            }
        });
    </script>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" class="loading-screen">
        <div class="dashboard-card">
            <img src="assets/RLlogo.png" alt="RabbitLoader" class="logo">
            <div class="store-name" id="storeName">Loading...</div>
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Checking connection...</p>
            </div>
        </div>
    </div>

    <!-- Disconnected State: Connect to RabbitLoader -->
    <div id="disconnectedState" class="page-state" style="display: none;">
        <div class="dashboard-card">
            <img src="assets/RLlogo.png" alt="RabbitLoader" class="logo">
            
            <div class="store-info">
                <div class="store-name" id="storeNameDisconnected">Loading...</div>
                <div class="connection-status">
                    <div class="status-indicator error"></div>
                    <span class="status-text">Not Connected</span>
                </div>
            </div>
            
            <div class="disconnected-section">
                <h1 class="main-title">Get 100/100 PageSpeed</h1>
                <p class="subtitle">on Google PageSpeed Insight</p>
                <a href="#" class="btn btn-primary" id="activateBtn">Activate RabbitLoader</a>
            </div>
            
            <div class="footer-links">
                <a href="#" class="footer-link">Crash Courses</a>
                <a href="#" class="footer-link">Terms & Conditions</a>
                <a href="#" class="footer-link">Get Support</a>
            </div>
        </div>
    </div>

    <!-- Connected State: Dashboard -->
    <div id="connectedState" class="page-state" style="display: none;">
        <div class="dashboard-container">
            <!-- Header -->
            <header class="dashboard-header">
                <img src="assets/RLlogo.png" alt="RabbitLoader" class="dashboard-logo">
                <h1 class="dashboard-title">RabbitLoader Dashboard</h1>
            </header>

            <!-- Connection Status Section -->
            <div class="card">
                <h2 class="card-title">Connection Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Shopify Connected:</span>
                        <span class="status-value connected">‚úÖ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">RabbitLoader Connected:</span>
                        <span class="status-value connected" id="rl-status">‚úÖ Connected</span>
                    </div>
                </div>
            </div>

            <!-- Plan Details Section -->
            <div class="card">
                <h2 class="card-title">Your Plan</h2>
                <div class="plan-grid">
                    <div class="plan-item">
                        <span class="plan-label">Plan:</span>
                        <span class="plan-value" id="plan-name">Loading...</span>
                    </div>
                    <div class="plan-item">
                        <span class="plan-label">Domain Limit:</span>
                        <span class="plan-value" id="plan-domains">Loading...</span>
                    </div>
                    <div class="plan-item">
                        <span class="plan-label">Monthly Pageviews:</span>
                        <span class="plan-value" id="plan-pageviews">Loading...</span>
                    </div>
                    <div class="plan-item">
                        <span class="plan-label">Current Usage:</span>
                        <span class="plan-value" id="plan-usage">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- PageSpeed Snapshot Section -->
            <div class="card">
                <h2 class="card-title">Site Performance</h2>
                <div class="performance-grid">
                    <div class="performance-main">
                        <div class="score-circle">
                            <span class="score-number" id="score">--</span>
                        </div>
                        <p class="score-label">Overall Score</p>
                    </div>
                    <div class="performance-metrics">
                        <div class="metric-item">
                            <span class="metric-label">LCP</span>
                            <span class="metric-value" id="lcp">--</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">CLS</span>
                            <span class="metric-value" id="cls">--</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">FID</span>
                            <span class="metric-value" id="fid">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="card">
                <h2 class="card-title">Actions</h2>
                <div class="actions-grid">
                    <a href="#" class="btn btn-success" id="injectBtn">üîß Inject Script</a>
                    <a href="#" class="btn btn-warning" id="revertBtn">üóëÔ∏è Revert Script</a>
                    <a href="#" class="btn btn-danger" id="disconnectBtn">üîå Disconnect</a>
                    <a href="https://rabbitloader.com/account/" class="btn btn-primary" target="_blank">View Report</a>
                </div>
            </div>

            <!-- DID Info -->
            <div class="card" id="didSection">
                <h2 class="card-title">Domain ID</h2>
                <p><strong>DID:</strong> <span id="didValue">-</span></p>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>